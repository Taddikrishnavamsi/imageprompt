<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt & Image Gallery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Add the Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Basic Styling */
        body {
            font-family: 'Orbitron', sans-serif;
            line-height: 1.6;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: rgba(10, 10, 10, 0.7);
            border: 2px solid;
            border-image-slice: 1;
            border-image-source: linear-gradient(135deg, #12f9ff, #ff00d4, #00ffae, #9800ff);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 24px #12f9ff, 0 0 30px #ff00d4;
            backdrop-filter: blur(3px);
        }

        h1 {
            color: #fff;
            text-shadow: 0 0 8px #12f9ff, 0 0 12px #12f9ff, 0 0 20px #12f9ff;
            text-align: center;
        }

        /* Form Styling */
        #content-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #ff00d4;
        }

        textarea, input[type="file"], input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #12f9ff;
            border-radius: 5px;
            background-color: #111;
            color: #fff;
            margin-bottom: 0.5rem; /* Add a little space between inputs */
            box-shadow: 0 0 5px #12f9ff inset;
            font-family: 'Orbitron', sans-serif;
        }

        button {
            background-color: #ff00d4;
            color: #fff;
            border: 1px solid #ff00d4;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            text-shadow: 0 0 5px #fff;
            box-shadow: 0 0 16px #00ffae, 0 0 20px #ff00d4;
        }

        button:hover {
            background-color: #12f9ff;
            border-color: #12f9ff;
            box-shadow: 0 0 20px #12f9ff, 0 0 30px #00ffae;
        }

        /* Unified Gallery Section Styling */
        .gallery-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            padding: 0; /* Remove padding as container has it */
            background: transparent;
            margin-top: 40px; /* Add some space above the new section */
            border-radius: 0;
            box-shadow: none;
        }

        .gallery-card {
            background: #111;
            border-radius: 22px;
            border: 1px solid #9800ff;
            box-shadow: 0 0 15px rgba(152, 0, 255, 0.5);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
            display: flex; /* Use flexbox for card content */
            flex-direction: column; /* Stack image and caption */
        }

        .gallery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 24px #12f9ff, 0 0 30px #ff00d4;
            border-color: #ff00d4;
        }

        .gallery-img {
            width: 100%;
            height: 220px;
            object-fit: contain; /* Ensures image covers the area without distortion */
            display: block; /* Remove extra space below image */
            cursor: pointer; /* Indicate the image is clickable */
        }

        .gallery-img.editable {
            cursor: pointer;
            outline: 3px dashed #12f9ff;
            outline-offset: -5px;
        }

        .gallery-caption {
            padding: 28px 24px 22px;
            text-align: left;
            flex-grow: 1; /* Allows caption to take remaining space if card is flex */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push description to bottom if needed */
            flex-grow: 1;
        }

        .gallery-caption-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 9px;
        }

        .caption-buttons {
            display: flex;
            gap: 8px; /* Adds space between buttons */
        }

        .gallery-title {
            font-size: 1.25rem;
            margin: 0; /* Remove default margin */
            font-weight: 600;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
        }

        .copy-btn {
            background-color: transparent;
            color: #12f9ff;
            border: 1px solid #12f9ff;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .edit-btn {
            background-color: transparent;
            color: #00ffae;
            border: 1px solid #00ffae;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .edit-btn:hover {
            background-color: #00ffae;
            color: #000;
        }

        .delete-btn {
            background-color: transparent;
            color: #ff00d4;
            border: 1px solid #ff00d4;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .delete-btn:hover {
            background-color: #ff00d4;
            color: #fff;
        }

        .gallery-desc {
            font-size: 1rem;
            color: #ccc;
            font-family: 'Orbitron', sans-serif;
            white-space: pre-wrap; /* Respect newlines in the prompt */
            display: none; /* Hide prompt text on the main card view */
        }

        .gallery-desc-editor {
            width: 100%;
            min-height: 80px; /* Give it some initial height */
            font-family: 'Orbitron', sans-serif;
            background-color: #111;
            color: #fff;
            border: 1px solid #12f9ff;
        }

        /* Responsive adjustments for the new gallery */
        @media (max-width: 600px) { /* Adjust breakpoint for gallery cards if needed */
            .gallery-section {
                padding: 20px;
            }
        }

        /* Lightbox Styling */
        .lightbox {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }

        .lightbox.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }

        .lightbox-card {
            background: #000;
            border-radius: 16px;
            border: 2px solid #ff00d4;
            box-shadow: 0 0 24px #ff00d4, 0 0 30px #9800ff;
            max-width: 70vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Important for border-radius on image */
        }

        .lightbox-content {
            width: 100%; /* Image takes full width of the card */
            max-height: 70vh; /* Limit image height to leave room for prompt */
            object-fit: contain;
        }

        .lightbox-prompt {
            color: #fff;
            text-align: left;
            padding: 15px 20px;
            font-size: 1rem;
            line-height: 1.5;
            overflow-y: auto; /* Add scroll if prompt is very long */
            background: #111;
            border-top: 1px solid #ff00d4;
            flex-shrink: 0; /* Prevent prompt from shrinking */
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: #ff00d4;
            text-shadow: 0 0 10px #ff00d4;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .lightbox-prev,
        .lightbox-next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            font-weight: bold;
            color: #12f9ff;
            text-shadow: 0 0 8px #12f9ff;
            padding: 16px;
            user-select: none; /* Prevent text selection */
            transition: color 0.2s, text-shadow 0.2s;
        }

        .lightbox-prev { left: 15px; }
        .lightbox-next { right: 15px; }

        .lightbox-prev:hover,
        .lightbox-next:hover {
            color: #fff;
            text-shadow: 0 0 15px #12f9ff;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>AI Prompt & Image Gallery</h1>

        <!-- Form to add new content -->
        <form id="content-form">
            <textarea id="prompt-input" placeholder="Enter the prompt used to generate the image..." rows="4" required></textarea>
            <input type="file" id="image-input" accept="image/*">
            <input type="text" id="image-url-input" placeholder="...or paste an image URL here">
            <button type="submit">Save Entry</button>
        </form>

        <!-- This container is now empty and will be populated by JavaScript -->
    </div>

    <!-- Unified Gallery Section - Populated by JavaScript -->
    <section id="gallery-container" class="gallery-section">
    </section>

    <!-- Lightbox Structure -->
    <div id="lightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <span class="lightbox-prev">&#10094;</span>
        <span class="lightbox-next">&#10095;</span>
        <div class="lightbox-card">
            <img class="lightbox-content" id="lightbox-img">
            <div class="lightbox-prompt" id="lightbox-prompt"></div>
        </div>
    </div>

    <script>
        const contentForm = document.getElementById('content-form');
        const promptInput = document.getElementById('prompt-input');
        const imageInput = document.getElementById('image-input');
        const imageUrlInput = document.getElementById('image-url-input');
        const galleryContainer = document.getElementById('gallery-container');

        // --- Supabase Setup ---
        // IMPORTANT: Replace with your actual Supabase URL and Anon Key from Part 1
        const SUPABASE_URL = 'https://qbgtvhemdkphrzzrftix.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZ3R2aGVtZGtwaHJ6enJmdGl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDUwMjYsImV4cCI6MjA3NDg4MTAyNn0.Bg1oa_4s4FVr_2Hk-Z-2sva5o_PZGoGOLA8glCXDcRc';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // This will hold our gallery data, fetched from Supabase
        let posts = [];

        // --- Main Application Logic ---

        // Load initial posts from Supabase when the page loads
        document.addEventListener('DOMContentLoaded', async () => {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                galleryContainer.innerHTML = `<p style="color: #ff00d4; text-align: center;">Error: Supabase credentials are not set. Please update the script with your URL and Anon Key.</p>`;
                return;
            }
            try {
                const { data, error } = await supabase.from('posts').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                posts = data;
                renderPosts();
            } catch (error) {
                console.error("Error loading posts from Supabase:", error);
                galleryContainer.innerHTML = `<p style="color: #ff00d4; text-align: center;">Error: Could not load gallery data from the database.</p>`;
            }
        });

        // Handle form submission
        contentForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent the page from reloading

            const promptText = promptInput.value;
            const imageFile = imageInput.files[0];
            const imageUrl = imageUrlInput.value.trim();

            if (!promptText || (!imageFile && !imageUrl)) {
                alert('Please provide a prompt and either upload an image or paste an image URL.');
                return;
            }

            const submitButton = contentForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            try {
                let finalImageUrl = imageUrl;

                // If a file is uploaded, prioritize it. Upload to Supabase Storage.
                if (imageFile) {
                    const fileName = `${Date.now()}-${imageFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('gallery-images')
                        .upload(fileName, imageFile);

                    if (uploadError) throw uploadError;

                    // Get the public URL for the uploaded image
                    const { data: urlData } = supabase.storage
                        .from('gallery-images')
                        .getPublicUrl(fileName);
                    
                    finalImageUrl = urlData.publicUrl;
                }

                // Save the prompt and the final image URL to the 'posts' table
                const { data: postData, error: postError } = await supabase
                    .from('posts')
                    .insert([{ prompt: promptText, image_url: finalImageUrl }])
                    .select()
                    .single();

                if (postError) throw postError;

                // Add the new post to the top of our local array and re-render
                posts.unshift(postData);
                renderPosts();
                contentForm.reset();

            } catch (error) {
                console.error('Error saving post:', error);
                alert(`Failed to save entry: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Save Entry';
            }
        });

        async function deletePost(postId, indexToDelete) {
            // Use a confirmation dialog before deleting
            if (!confirm('Are you sure you want to delete this entry?')) {
                return; // Stop if the user cancels
            }

            try {
                // Also delete the image from storage to keep things clean
                const postToDelete = posts[indexToDelete];
                if (postToDelete && postToDelete.image_url) {
                    const imageUrl = new URL(postToDelete.image_url);
                    const imagePath = imageUrl.pathname.split('/gallery-images/')[1];
                    if (imagePath) {
                        await supabase.storage.from('gallery-images').remove([imagePath]);
                    }
                }

                // Delete the post from the database
                const { error } = await supabase.from('posts').delete().eq('id', postId);
                if (error) throw error;

                // Remove from local array and re-render
                posts.splice(indexToDelete, 1);
                renderPosts();

            } catch (error) {
                console.error('Error deleting post:', error);
                alert(`Failed to delete entry: ${error.message}`);
            }
        }

        async function updatePost(postId, indexToUpdate, { newPrompt, newImage }) {
            try {
                const updates = { prompt: newPrompt };
                // Note: Image updating is complex and not implemented in this version.
                // We will only update the prompt text for now.
                const { data, error } = await supabase.from('posts').update(updates).eq('id', postId).select().single();
                if (error) throw error;

                // Update local array and re-render
                posts[indexToUpdate] = data;
                renderPosts();
            } catch (error) {
                console.error('Error updating post:', error);
                alert(`Failed to update entry: ${error.message}`);
            }
        }

        function renderPosts() {
            galleryContainer.innerHTML = ''; // Clear existing content

            if (posts.length === 0) {
                galleryContainer.innerHTML = `<p style="color: #ccc; text-align: center;">Your gallery is empty. Add an entry using the form above.</p>`;
                return;
            }

            posts.forEach((post, index) => {
                // Guard clause to prevent errors from malformed data in localStorage
                if (!post || typeof post.prompt === 'undefined' || typeof post.image_url === 'undefined') {
                    console.warn(`Skipping invalid post data at index: ${index}`, post);
                    return; // Skip this iteration and continue with the next post
                }

                // --- Create Gallery Card ---
                const card = document.createElement('div');
                card.className = 'gallery-card';

                // Image
                const img = document.createElement('img');
                img.className = 'gallery-img';
                img.src = post.image_url;
                img.alt = `AI generated image for prompt: ${(post.prompt || '').substring(0, 50)}...`;
                img.dataset.index = index; // Add index for lightbox navigation

                // Add an error handler for broken image links or CORS issues
                // Use a self-contained SVG data URI as a fallback to ensure it works offline.
                img.onerror = function() {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiB2aWV3Qm94PSIwIDAgNjAwIDQwMCI+PHJlY3Qgd2lkdGg9IjYwMCIgaGVpZ2h0PSI0MDAiIGZpbGw9IiMxMTEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9Ik9yYml0cm9uLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0IiBmaWxsPSIjZmYwMGQ0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5FcnJvciBMb2FkaW5nIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
                    this.alt = 'Error: Image could not be loaded from the provided URL.';
                };

                // Caption
                const caption = document.createElement('div');
                caption.className = 'gallery-caption';

                // Caption Header
                const captionHeader = document.createElement('div');
                captionHeader.className = 'gallery-caption-header';

                // Title
                const title = document.createElement('h3');
                title.className = 'gallery-title';
                title.textContent = 'Prompt';

                // Container for buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'caption-buttons';

                // Edit Button
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.onclick = function() {
                    toggleEditMode(card, post.id, index);
                };

                // Copy Button for the caption
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = function() {
                    navigator.clipboard.writeText(post.prompt || '').then(() => {
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                };

                // Delete Button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = function() {
                    deletePost(post.id, index);
                };

                captionHeader.appendChild(title);
                buttonContainer.appendChild(editBtn);
                buttonContainer.appendChild(copyBtn);
                buttonContainer.appendChild(deleteBtn);
                captionHeader.appendChild(buttonContainer);

                // Description (the full prompt)
                const desc = document.createElement('p');
                desc.className = 'gallery-desc';
                desc.textContent = post.prompt || '';

                caption.appendChild(captionHeader);
                caption.appendChild(desc);

                card.appendChild(img);
                card.appendChild(caption);
                galleryContainer.appendChild(card);
            });
        }

        function toggleEditMode(card, postId, index) {
            const caption = card.querySelector('.gallery-caption');
            const descElement = card.querySelector('.gallery-desc');
            const imgElement = card.querySelector('.gallery-img');
            const buttonContainer = card.querySelector('.caption-buttons');
            const originalButtons = buttonContainer.innerHTML; // Save original buttons
            const originalImageSrc = imgElement.src;
            let newImageDataUrl = null;

            // NOTE: Image editing is disabled for this version as it adds complexity.
            // --- Set up image editing ---
            imgElement.classList.add('editable');
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            card.appendChild(fileInput); // Add to card to keep it in scope

            // imgElement.onclick = () => {
            //     fileInput.click();
            // };

            // fileInput.onchange = () => {
            //     const file = fileInput.files[0];
            //     if (!file) return;
            //     const reader = new FileReader();
            //     reader.onload = (e) => {
            //         newImageDataUrl = e.target.result;
            //         imgElement.src = newImageDataUrl; // Show preview
            //     };
            //     reader.readAsDataURL(file);
            // };
            imgElement.title = "Image editing is not supported in this version.";

            // Create a textarea for editing
            const editor = document.createElement('textarea');
            editor.className = 'gallery-desc-editor';
            editor.value = descElement.textContent;

            // Replace the <p> with the <textarea>
            caption.replaceChild(editor, descElement);
            editor.focus();

            // Create Save and Cancel buttons
            const saveBtn = document.createElement('button');
            saveBtn.className = 'copy-btn'; // Re-use a style, e.g., green-ish
            saveBtn.textContent = 'Save';
            // No need for inline styles, it will inherit the .copy-btn look

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'delete-btn'; // Re-use a style, e.g., red-ish
            cancelBtn.textContent = 'Cancel';

            // --- Event Handlers for new buttons ---

            function exitEditMode() {
                // Create a new <p> element to replace the editor
                const newDesc = document.createElement('p');
                newDesc.className = 'gallery-desc';
                newDesc.textContent = descElement.textContent; // Restore original text

                caption.replaceChild(newDesc, editor);
                buttonContainer.innerHTML = originalButtons; // Restore original buttons
                imgElement.src = originalImageSrc; // Restore original image
                imgElement.classList.remove('editable');
                imgElement.onclick = null; // Remove the edit-mode click handler
                card.removeChild(fileInput); // Clean up the file input element

                // We must re-attach event listeners since innerHTML wipes them
                buttonContainer.querySelector('.edit-btn').onclick = () => toggleEditMode(card, postId, index);
                const copyBtn = buttonContainer.querySelector('.copy-btn');
                copyBtn.onclick = () => { navigator.clipboard.writeText(newDesc.textContent).then(() => { copyBtn.textContent = 'Copied!'; setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000); }); };
                buttonContainer.querySelector('.delete-btn').onclick = () => deletePost(postId, index);

            }

            saveBtn.onclick = () => {
                const newPromptText = editor.value;
                if (newPromptText.trim() === '') {
                    alert('Prompt cannot be empty.');
                    return;
                }
                // newImage is null because we disabled image editing for simplicity
                updatePost(postId, index, { newPrompt: newPromptText, newImage: null });
            };

            cancelBtn.onclick = () => {
                exitEditMode();
            };

            buttonContainer.innerHTML = ''; // Clear existing buttons
            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
        }

        // --- Lightbox Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const lightboxPrompt = document.getElementById('lightbox-prompt');
            const lightboxClose = document.querySelector('.lightbox-close');
            const lightboxPrev = document.querySelector('.lightbox-prev');
            const lightboxNext = document.querySelector('.lightbox-next');
            
            let currentImageIndex = 0;

            function showImage(index) {
                if (index >= posts.length || index < 0) {
                    console.error("Image index out of bounds");
                    return;
                }
                currentImageIndex = index;
                lightboxImg.src = posts[currentImageIndex].image_url;
                lightboxPrompt.textContent = posts[currentImageIndex].prompt || '';
                lightbox.classList.add('visible');
            }

            function showNextImage() {
                if (posts.length === 0) return;
                const nextIndex = (currentImageIndex + 1) % posts.length; // Loop to start
                showImage(nextIndex);
            }

            function showPrevImage() {
                if (posts.length === 0) return;
                const prevIndex = (currentImageIndex - 1 + posts.length) % posts.length; // Loop to end
                showImage(prevIndex);
            }

            function closeLightbox() {
                lightbox.classList.remove('visible');
                // Optional: Reset src to prevent showing old image briefly on next open
                setTimeout(() => { 
                    lightboxImg.src = ''; 
                    lightboxPrompt.textContent = '';
                }, 300);
            }

            // Event Listeners
            galleryContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('gallery-img') && !e.target.classList.contains('editable')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    showImage(index);
                }
            });

            lightboxNext.addEventListener('click', showNextImage);
            lightboxPrev.addEventListener('click', showPrevImage);
            lightboxClose.addEventListener('click', closeLightbox);
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) { // Only close if clicking the background
                    closeLightbox();
                }
            });
        });
    </script>

</body>
</html>
